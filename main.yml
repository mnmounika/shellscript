---
- name: CI
  environment:
    CSR_countryName: "US"
    CSR_stateOrProvinceName: "Michigan"
    CSR_localityName: "Troy"
    CSR_organizationalUnitName: "Vehma International"
    CSR_commonName: "cse-plant1-uns.magna.global"
  tasks:
    - name: Install Docker
      shell: |
        curl -fsSL https://get.docker.com -o get-docker.sh
        sudo sh get-docker.sh
        sudo usermod -aG docker $USER
      args:
        executable: /bin/bash

    - name: Generate certificate
      shell: |
        echo "Cert creation starts"
        openssl req \
        -nodes \
        -newkey rsa:2048 \
        -subj "/C=$CSR_countryName/ST=$CSR_stateOrProvinceName/L=$CSR_localityName/O=Magna International/OU=$CSR_organizationalUnitName/CN=$CSR_commonName" \
        -addext "keyUsage = digitalSignature, keyEncipherment" \
        -addext "extendedKeyUsage = serverAuth, clientAuth" \
        -addext "subjectAltName = DNS:$CSR_commonName" \
        -keyout $CSR_commonName.key \
        -out $CSR_commonName.csr
        echo "::$CSR_commonName.key got created"
        echo "::$CSR_commonName.csr got created"
        echo "pwd"
        pwd
        ls -lrt
        echo "ls -lrt"
        echo "Cert creation ends"
      args:
        executable: /bin/bash

    - name: Create folder certs
      command: >
        sudo mkdir -p /opt/mosquitto/certs &&
        sudo cp -R /home/runner/work/shellscript/shellscript/{{ CSR_commonName }}.key /opt/mosquitto/certs/
      args:
        executable: /bin/bash

    - name: Create directory config,data
      command: >
        sudo mkdir -p /opt/mosquitto/config &&
        sudo mkdir -p /opt/mosquitto/data
      args:
        executable: /bin/bash

    - name: Create file
      command: >
        sudo bash -c 'cat > /opt/mosquitto/config/mosquitto.conf << EOF
        per_listener_settings false
        plugin /usr/lib/mosquitto_dynamic_security.so
        plugin_opt_config_file /mosquitto/config/dynamic-security.json
        persistence true
        persistence_location /mosquitto/data
        log_dest topic
        log_dest stdout
        log_timestamp true
        log_timestamp_format %Y-%m-%dT%H:%M:%S%z
        log_type all

        #MQTT Listener
        listener 8883
        protocol mqtt
        certfile /mosquitto/certs/{{ CSR_commonName }}.pem
        keyfile /mosquitto/certs/{{ CSR_commonName }}.key
        cafile /mosquitto/certs/magna_global_fullchain.pem
        # minimum version of the TLS protocol
        tls_version tlsv1.2

        #Websocket Listener
        listener 443
        protocol websockets
        certfile /mosquitto/certs/{{ CSR_commonName }}.pem
        keyfile /mosquitto/certs/{{ CSR_commonName }}.key
        cafile /mosquitto/certs/magna_global_fullchain.pem
        # minimum version of the TLS protocol
        tls_version tlsv1.2
        EOF'
      args:
        executable: /bin/bash

    - name: Run script file
      shell: |
        chmod +x ./test.sh
        ./test.sh
      args:
        executable: /bin/bash
